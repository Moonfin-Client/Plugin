<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Moonfin</title>
</head>
<body>
    <div id="MoonfinConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="MoonfinConfigForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Moonfin Settings</h2>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">General</h3>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="EnableSettingsSync" is="emby-checkbox" />
                                <span>Enable Settings Sync</span>
                            </label>
                            <div class="fieldDescription">
                                Allow Moonfin clients to sync their settings across devices via this server.
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Jellyseerr / Seerr Integration</h3>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input type="checkbox" id="JellyseerrEnabled" is="emby-checkbox" />
                                <span>Enable Jellyseerr / Seerr</span>
                            </label>
                            <div class="fieldDescription">
                                Enable Jellyseerr or Seerr integration for all users. Users can configure their own authentication method in their client settings.
                            </div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="JellyseerrUrl">Jellyseerr/Seerr URL</label>
                            <input type="url" id="JellyseerrUrl" is="emby-input" placeholder="https://jellyseerr.example.com" />
                            <div class="fieldDescription">
                                The URL of your Jellyseerr or Seerr instance. This URL is used for server-to-server API proxying.
                            </div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="JellyseerrDisplayName">Display Name (Optional)</label>
                            <input type="text" id="JellyseerrDisplayName" is="emby-input" placeholder="Auto-detected" />
                            <div class="fieldDescription">
                                <strong>Optional override.</strong> The name shown in the UI (e.g., "Requests", "Media Requests").
                                Leave blank to auto-detect "Jellyseerr" or "Seerr" based on the configured URL.
                                The icon is always auto-detected regardless of this setting.
                            </div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="JellyseerrDirectUrl">Direct Iframe URL (Advanced)</label>
                            <input type="url" id="JellyseerrDirectUrl" is="emby-input" placeholder="https://jellyseerr.yourdomain.com" />
                            <div class="fieldDescription">
                                <strong>Optional:</strong> When set, the client-side iframe loads directly from this URL
                                instead of through the proxy. Use this if you're running Seerr v3 (Next.js) behind a reverse proxy
                                and experiencing issues with the default proxy mode.
                                <br><br>
                                <strong>When to use:</strong> If Seerr works when accessed directly but not through Moonfin's proxy,
                                set this to your public Seerr URL (e.g., <code>https://seerr.yourdomain.com</code>).
                                SSO API calls will still go through the Jellyfin server.
                            </div>
                        </div>
                        <div style="background-color: rgba(0, 164, 220, 0.1); border-left: 4px solid #00a4dc; border-radius: 4px; padding: 1em 1.5em; margin: 1em 0;">
                            <strong>SSO Proxy:</strong> When Jellyseerr is enabled, Moonfin provides single sign-on.
                            Users authenticate once with their Jellyfin credentials, and the session is stored server-side.
                            All Moonfin clients (web, Android, Roku, webOS, Tizen, etc) can access Jellyseerr through <code>/Moonfin/Jellyseerr/Api/</code>
                            without re-authenticating.
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">MDBList Integration</h3>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MdblistApiKey">Server-wide MDBList API Key</label>
                            <input type="password" id="MdblistApiKey" is="emby-input" placeholder="Enter your mdblist.com API key" />
                            <div class="fieldDescription">
                                Provide a server-wide <a href="https://mdblist.com/preferences/" target="_blank">MDBList API key</a>
                                that all users can use for ratings (IMDb, Rotten Tomatoes, Metacritic, etc.).
                                Users who set their own key in their Moonfin client settings will use that instead.
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">TMDB Integration</h3>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="TmdbApiKey">Server-wide TMDB API Key</label>
                            <input type="password" id="TmdbApiKey" is="emby-input" placeholder="Enter your TMDB API key or v4 token" />
                            <div class="fieldDescription">
                                Provide a server-wide <a href="https://www.themoviedb.org/settings/api" target="_blank">TMDB API key</a>
                                that all users can use for episode ratings.
                                Users who set their own key in their Moonfin client settings will use that instead.
                                Supports both v3 API keys and v4 Bearer tokens.
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Web Plugin Status</h3>
                        <div class="fieldDescription" style="margin-bottom: 1em;">
                            <p>Moonfin uses the
                                <a href="https://github.com/IAmParadox27/jellyfin-plugin-file-transformation" target="_blank">File Transformation</a>
                                plugin to inject its web UI.
                            </p>
                            <p style="margin-top: 0.5em;">
                                <strong>Setup:</strong>
                            </p>
                            <ol style="margin-left: 1.5em;">
                                <li>Install the <strong>File Transformation</strong> plugin (add <code>https://www.iamparadox.dev/jellyfin/plugins/manifest.json</code> to your plugin repositories)</li>
                                <li>Restart Jellyfin</li>
                                <li>Force refresh your browser (Ctrl+Shift+R)</li>
                            </ol>
                            <p style="margin-top: 0.5em;">
                                <strong>UI not loading?</strong> Go to <em>Dashboard &gt; Scheduled Tasks</em> and run the
                                <strong>Moonfin Startup</strong> task once, then refresh your browser.
                            </p>
                        </div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var MoonfinConfig = {
                pluginUniqueId: '8c5d0e91-4f2a-4b6d-9e3f-1a7c8d9e0f2b'
            };

            document.addEventListener('pageshow', function(e) {
                if (e.target.id !== 'MoonfinConfigPage') return;

                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(MoonfinConfig.pluginUniqueId).then(function(config) {
                    document.querySelector('#EnableSettingsSync').checked = config.EnableSettingsSync;
                    document.querySelector('#JellyseerrEnabled').checked = config.JellyseerrEnabled;
                    document.querySelector('#JellyseerrUrl').value = config.JellyseerrUrl || '';
                    document.querySelector('#JellyseerrDirectUrl').value = config.JellyseerrDirectUrl || '';
                    document.querySelector('#JellyseerrDisplayName').value = config.JellyseerrDisplayName || '';
                    document.querySelector('#MdblistApiKey').value = config.MdblistApiKey || '';
                    document.querySelector('#TmdbApiKey').value = config.TmdbApiKey || '';
                    Dashboard.hideLoadingMsg();
                });

                document.querySelector('#MoonfinConfigForm')
                    .addEventListener('submit', function(ev) {
                        ev.preventDefault();
                        Dashboard.showLoadingMsg();
                        ApiClient.getPluginConfiguration(MoonfinConfig.pluginUniqueId).then(function(config) {
                            config.EnableSettingsSync = document.querySelector('#EnableSettingsSync').checked;
                            config.JellyseerrEnabled = document.querySelector('#JellyseerrEnabled').checked;
                            config.JellyseerrUrl = document.querySelector('#JellyseerrUrl').value || null;
                            config.JellyseerrDirectUrl = document.querySelector('#JellyseerrDirectUrl').value || null;
                            config.JellyseerrDisplayName = document.querySelector('#JellyseerrDisplayName').value || null;
                            config.MdblistApiKey = document.querySelector('#MdblistApiKey').value || null;
                            config.TmdbApiKey = document.querySelector('#TmdbApiKey').value || null;
                            ApiClient.updatePluginConfiguration(MoonfinConfig.pluginUniqueId, config).then(function(result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                            });
                        });
                        return false;
                    });
            });
        </script>
    </div>
</body>
</html>
